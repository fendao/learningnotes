```python
import matplotlib.pyplot as plt
import pandas as pd
import numpy as np
import matplotlib as mpl
plt.rcParams['font.sans-serif'] = ['Arial Unicode MS']
```

# DeepDream

## Inception模型


```python
from keras.applications import inception_v3
from keras import backend as K
import tensorflow as tf
tf.compat.v1.disable_eager_execution()
# 禁用训练功能
K.set_learning_phase(0)
model = inception_v3.InceptionV3(weights='imagenet', include_top=False)
model.summary()
```

    

    Model: "inception_v3"
    __________________________________________________________________________________________________
     Layer (type)                   Output Shape         Param #     Connected to                     
    ==================================================================================================
     input_1 (InputLayer)           [(None, None, None,  0           []                               
                                     3)]                                                              
                                                                                                      
     conv2d (Conv2D)                (None, None, None,   864         ['input_1[0][0]']                
                                    32)                                                               
                                                                                                      
     batch_normalization (BatchNorm  (None, None, None,   96         ['conv2d[0][0]']                 
     alization)                     32)                                                               
                                                                                                      
     activation (Activation)        (None, None, None,   0           ['batch_normalization[0][0]']    
                                    32)                                                               
                                                                                                      
     conv2d_1 (Conv2D)              (None, None, None,   9216        ['activation[0][0]']             
                                    32)                                                               
                                                                                                      
     batch_normalization_1 (BatchNo  (None, None, None,   96         ['conv2d_1[0][0]']               
     rmalization)                   32)                                                               
                                                                                                      
     activation_1 (Activation)      (None, None, None,   0           ['batch_normalization_1[0][0]']  
                                    32)                                                               
                                                                                                      
     conv2d_2 (Conv2D)              (None, None, None,   18432       ['activation_1[0][0]']           
                                    64)                                                               
                                                                                                      
     batch_normalization_2 (BatchNo  (None, None, None,   192        ['conv2d_2[0][0]']               
     rmalization)                   64)                                                               
                                                                                                      
     activation_2 (Activation)      (None, None, None,   0           ['batch_normalization_2[0][0]']  
                                    64)                                                               
                                                                                                      
     max_pooling2d (MaxPooling2D)   (None, None, None,   0           ['activation_2[0][0]']           
                                    64)                                                               
                                                                                                      
     conv2d_3 (Conv2D)              (None, None, None,   5120        ['max_pooling2d[0][0]']          
                                    80)                                                               
                                                                                                      
     batch_normalization_3 (BatchNo  (None, None, None,   240        ['conv2d_3[0][0]']               
     rmalization)                   80)                                                               
                                                                                                      
     activation_3 (Activation)      (None, None, None,   0           ['batch_normalization_3[0][0]']  
                                    80)                                                               
                                                                                                      
     conv2d_4 (Conv2D)              (None, None, None,   138240      ['activation_3[0][0]']           
                                    192)                                                              
                                                                                                      
     batch_normalization_4 (BatchNo  (None, None, None,   576        ['conv2d_4[0][0]']               
     rmalization)                   192)                                                              
                                                                                                      
     activation_4 (Activation)      (None, None, None,   0           ['batch_normalization_4[0][0]']  
                                    192)                                                              
                                                                                                      
     max_pooling2d_1 (MaxPooling2D)  (None, None, None,   0          ['activation_4[0][0]']           
                                    192)                                                              
                                                                                                      
     conv2d_8 (Conv2D)              (None, None, None,   12288       ['max_pooling2d_1[0][0]']        
                                    64)                                                               
                                                                                                      
     batch_normalization_8 (BatchNo  (None, None, None,   192        ['conv2d_8[0][0]']               
     rmalization)                   64)                                                               
                                                                                                      
     activation_8 (Activation)      (None, None, None,   0           ['batch_normalization_8[0][0]']  
                                    64)                                                               
                                                                                                      
     conv2d_6 (Conv2D)              (None, None, None,   9216        ['max_pooling2d_1[0][0]']        
                                    48)                                                               
                                                                                                      
     conv2d_9 (Conv2D)              (None, None, None,   55296       ['activation_8[0][0]']           
                                    96)                                                               
                                                                                                      
     batch_normalization_6 (BatchNo  (None, None, None,   144        ['conv2d_6[0][0]']               
     rmalization)                   48)                                                               
                                                                                                      
     batch_normalization_9 (BatchNo  (None, None, None,   288        ['conv2d_9[0][0]']               
     rmalization)                   96)                                                               
                                                                                                      
     activation_6 (Activation)      (None, None, None,   0           ['batch_normalization_6[0][0]']  
                                    48)                                                               
                                                                                                      
     activation_9 (Activation)      (None, None, None,   0           ['batch_normalization_9[0][0]']  
                                    96)                                                               
                                                                                                      
     average_pooling2d (AveragePool  (None, None, None,   0          ['max_pooling2d_1[0][0]']        
     ing2D)                         192)                                                              
                                                                                                      
     conv2d_5 (Conv2D)              (None, None, None,   12288       ['max_pooling2d_1[0][0]']        
                                    64)                                                               
                                                                                                      
     conv2d_7 (Conv2D)              (None, None, None,   76800       ['activation_6[0][0]']           
                                    64)                                                               
                                                                                                      
     conv2d_10 (Conv2D)             (None, None, None,   82944       ['activation_9[0][0]']           
                                    96)                                                               
                                                                                                      
     conv2d_11 (Conv2D)             (None, None, None,   6144        ['average_pooling2d[0][0]']      
                                    32)                                                               
                                                                                                      
     batch_normalization_5 (BatchNo  (None, None, None,   192        ['conv2d_5[0][0]']               
     rmalization)                   64)                                                               
                                                                                                      
     batch_normalization_7 (BatchNo  (None, None, None,   192        ['conv2d_7[0][0]']               
     rmalization)                   64)                                                               
                                                                                                      
     batch_normalization_10 (BatchN  (None, None, None,   288        ['conv2d_10[0][0]']              
     ormalization)                  96)                                                               
                                                                                                      
     batch_normalization_11 (BatchN  (None, None, None,   96         ['conv2d_11[0][0]']              
     ormalization)                  32)                                                               
                                                                                                      
     activation_5 (Activation)      (None, None, None,   0           ['batch_normalization_5[0][0]']  
                                    64)                                                               
                                                                                                      
     activation_7 (Activation)      (None, None, None,   0           ['batch_normalization_7[0][0]']  
                                    64)                                                               
                                                                                                      
     activation_10 (Activation)     (None, None, None,   0           ['batch_normalization_10[0][0]'] 
                                    96)                                                               
                                                                                                      
     activation_11 (Activation)     (None, None, None,   0           ['batch_normalization_11[0][0]'] 
                                    32)                                                               
                                                                                                      
     mixed0 (Concatenate)           (None, None, None,   0           ['activation_5[0][0]',           
                                    256)                              'activation_7[0][0]',           
                                                                      'activation_10[0][0]',          
                                                                      'activation_11[0][0]']          
                                                                                                      
     conv2d_15 (Conv2D)             (None, None, None,   16384       ['mixed0[0][0]']                 
                                    64)                                                               
                                                                                                      
     batch_normalization_15 (BatchN  (None, None, None,   192        ['conv2d_15[0][0]']              
     ormalization)                  64)                                                               
                                                                                                      
     activation_15 (Activation)     (None, None, None,   0           ['batch_normalization_15[0][0]'] 
                                    64)                                                               
                                                                                                      
     conv2d_13 (Conv2D)             (None, None, None,   12288       ['mixed0[0][0]']                 
                                    48)                                                               
                                                                                                      
     conv2d_16 (Conv2D)             (None, None, None,   55296       ['activation_15[0][0]']          
                                    96)                                                               
                                                                                                      
     batch_normalization_13 (BatchN  (None, None, None,   144        ['conv2d_13[0][0]']              
     ormalization)                  48)                                                               
                                                                                                      
     batch_normalization_16 (BatchN  (None, None, None,   288        ['conv2d_16[0][0]']              
     ormalization)                  96)                                                               
                                                                                                      
     activation_13 (Activation)     (None, None, None,   0           ['batch_normalization_13[0][0]'] 
                                    48)                                                               
                                                                                                      
     activation_16 (Activation)     (None, None, None,   0           ['batch_normalization_16[0][0]'] 
                                    96)                                                               
                                                                                                      
     average_pooling2d_1 (AveragePo  (None, None, None,   0          ['mixed0[0][0]']                 
     oling2D)                       256)                                                              
                                                                                                      
     conv2d_12 (Conv2D)             (None, None, None,   16384       ['mixed0[0][0]']                 
                                    64)                                                               
                                                                                                      
     conv2d_14 (Conv2D)             (None, None, None,   76800       ['activation_13[0][0]']          
                                    64)                                                               
                                                                                                      
     conv2d_17 (Conv2D)             (None, None, None,   82944       ['activation_16[0][0]']          
                                    96)                                                               
                                                                                                      
     conv2d_18 (Conv2D)             (None, None, None,   16384       ['average_pooling2d_1[0][0]']    
                                    64)                                                               
                                                                                                      
     batch_normalization_12 (BatchN  (None, None, None,   192        ['conv2d_12[0][0]']              
     ormalization)                  64)                                                               
                                                                                                      
     batch_normalization_14 (BatchN  (None, None, None,   192        ['conv2d_14[0][0]']              
     ormalization)                  64)                                                               
                                                                                                      
     batch_normalization_17 (BatchN  (None, None, None,   288        ['conv2d_17[0][0]']              
     ormalization)                  96)                                                               
                                                                                                      
     batch_normalization_18 (BatchN  (None, None, None,   192        ['conv2d_18[0][0]']              
     ormalization)                  64)                                                               
                                                                                                      
     activation_12 (Activation)     (None, None, None,   0           ['batch_normalization_12[0][0]'] 
                                    64)                                                               
                                                                                                      
     activation_14 (Activation)     (None, None, None,   0           ['batch_normalization_14[0][0]'] 
                                    64)                                                               
                                                                                                      
     activation_17 (Activation)     (None, None, None,   0           ['batch_normalization_17[0][0]'] 
                                    96)                                                               
                                                                                                      
     activation_18 (Activation)     (None, None, None,   0           ['batch_normalization_18[0][0]'] 
                                    64)                                                               
                                                                                                      
     mixed1 (Concatenate)           (None, None, None,   0           ['activation_12[0][0]',          
                                    288)                              'activation_14[0][0]',          
                                                                      'activation_17[0][0]',          
                                                                      'activation_18[0][0]']          
                                                                                                      
     conv2d_22 (Conv2D)             (None, None, None,   18432       ['mixed1[0][0]']                 
                                    64)                                                               
                                                                                                      
     batch_normalization_22 (BatchN  (None, None, None,   192        ['conv2d_22[0][0]']              
     ormalization)                  64)                                                               
                                                                                                      
     activation_22 (Activation)     (None, None, None,   0           ['batch_normalization_22[0][0]'] 
                                    64)                                                               
                                                                                                      
     conv2d_20 (Conv2D)             (None, None, None,   13824       ['mixed1[0][0]']                 
                                    48)                                                               
                                                                                                      
     conv2d_23 (Conv2D)             (None, None, None,   55296       ['activation_22[0][0]']          
                                    96)                                                               
                                                                                                      
     batch_normalization_20 (BatchN  (None, None, None,   144        ['conv2d_20[0][0]']              
     ormalization)                  48)                                                               
                                                                                                      
     batch_normalization_23 (BatchN  (None, None, None,   288        ['conv2d_23[0][0]']              
     ormalization)                  96)                                                               
                                                                                                      
     activation_20 (Activation)     (None, None, None,   0           ['batch_normalization_20[0][0]'] 
                                    48)                                                               
                                                                                                      
     activation_23 (Activation)     (None, None, None,   0           ['batch_normalization_23[0][0]'] 
                                    96)                                                               
                                                                                                      
     average_pooling2d_2 (AveragePo  (None, None, None,   0          ['mixed1[0][0]']                 
     oling2D)                       288)                                                              
                                                                                                      
     conv2d_19 (Conv2D)             (None, None, None,   18432       ['mixed1[0][0]']                 
                                    64)                                                               
                                                                                                      
     conv2d_21 (Conv2D)             (None, None, None,   76800       ['activation_20[0][0]']          
                                    64)                                                               
                                                                                                      
     conv2d_24 (Conv2D)             (None, None, None,   82944       ['activation_23[0][0]']          
                                    96)                                                               
                                                                                                      
     conv2d_25 (Conv2D)             (None, None, None,   18432       ['average_pooling2d_2[0][0]']    
                                    64)                                                               
                                                                                                      
     batch_normalization_19 (BatchN  (None, None, None,   192        ['conv2d_19[0][0]']              
     ormalization)                  64)                                                               
                                                                                                      
     batch_normalization_21 (BatchN  (None, None, None,   192        ['conv2d_21[0][0]']              
     ormalization)                  64)                                                               
                                                                                                      
     batch_normalization_24 (BatchN  (None, None, None,   288        ['conv2d_24[0][0]']              
     ormalization)                  96)                                                               
                                                                                                      
     batch_normalization_25 (BatchN  (None, None, None,   192        ['conv2d_25[0][0]']              
     ormalization)                  64)                                                               
                                                                                                      
     activation_19 (Activation)     (None, None, None,   0           ['batch_normalization_19[0][0]'] 
                                    64)                                                               
                                                                                                      
     activation_21 (Activation)     (None, None, None,   0           ['batch_normalization_21[0][0]'] 
                                    64)                                                               
                                                                                                      
     activation_24 (Activation)     (None, None, None,   0           ['batch_normalization_24[0][0]'] 
                                    96)                                                               
                                                                                                      
     activation_25 (Activation)     (None, None, None,   0           ['batch_normalization_25[0][0]'] 
                                    64)                                                               
                                                                                                      
     mixed2 (Concatenate)           (None, None, None,   0           ['activation_19[0][0]',          
                                    288)                              'activation_21[0][0]',          
                                                                      'activation_24[0][0]',          
                                                                      'activation_25[0][0]']          
                                                                                                      
     conv2d_27 (Conv2D)             (None, None, None,   18432       ['mixed2[0][0]']                 
                                    64)                                                               
                                                                                                      
     batch_normalization_27 (BatchN  (None, None, None,   192        ['conv2d_27[0][0]']              
     ormalization)                  64)                                                               
                                                                                                      
     activation_27 (Activation)     (None, None, None,   0           ['batch_normalization_27[0][0]'] 
                                    64)                                                               
                                                                                                      
     conv2d_28 (Conv2D)             (None, None, None,   55296       ['activation_27[0][0]']          
                                    96)                                                               
                                                                                                      
     batch_normalization_28 (BatchN  (None, None, None,   288        ['conv2d_28[0][0]']              
     ormalization)                  96)                                                               
                                                                                                      
     activation_28 (Activation)     (None, None, None,   0           ['batch_normalization_28[0][0]'] 
                                    96)                                                               
                                                                                                      
     conv2d_26 (Conv2D)             (None, None, None,   995328      ['mixed2[0][0]']                 
                                    384)                                                              
                                                                                                      
     conv2d_29 (Conv2D)             (None, None, None,   82944       ['activation_28[0][0]']          
                                    96)                                                               
                                                                                                      
     batch_normalization_26 (BatchN  (None, None, None,   1152       ['conv2d_26[0][0]']              
     ormalization)                  384)                                                              
                                                                                                      
     batch_normalization_29 (BatchN  (None, None, None,   288        ['conv2d_29[0][0]']              
     ormalization)                  96)                                                               
                                                                                                      
     activation_26 (Activation)     (None, None, None,   0           ['batch_normalization_26[0][0]'] 
                                    384)                                                              
                                                                                                      
     activation_29 (Activation)     (None, None, None,   0           ['batch_normalization_29[0][0]'] 
                                    96)                                                               
                                                                                                      
     max_pooling2d_2 (MaxPooling2D)  (None, None, None,   0          ['mixed2[0][0]']                 
                                    288)                                                              
                                                                                                      
     mixed3 (Concatenate)           (None, None, None,   0           ['activation_26[0][0]',          
                                    768)                              'activation_29[0][0]',          
                                                                      'max_pooling2d_2[0][0]']        
                                                                                                      
     conv2d_34 (Conv2D)             (None, None, None,   98304       ['mixed3[0][0]']                 
                                    128)                                                              
                                                                                                      
     batch_normalization_34 (BatchN  (None, None, None,   384        ['conv2d_34[0][0]']              
     ormalization)                  128)                                                              
                                                                                                      
     activation_34 (Activation)     (None, None, None,   0           ['batch_normalization_34[0][0]'] 
                                    128)                                                              
                                                                                                      
     conv2d_35 (Conv2D)             (None, None, None,   114688      ['activation_34[0][0]']          
                                    128)                                                              
                                                                                                      
     batch_normalization_35 (BatchN  (None, None, None,   384        ['conv2d_35[0][0]']              
     ormalization)                  128)                                                              
                                                                                                      
     activation_35 (Activation)     (None, None, None,   0           ['batch_normalization_35[0][0]'] 
                                    128)                                                              
                                                                                                      
     conv2d_31 (Conv2D)             (None, None, None,   98304       ['mixed3[0][0]']                 
                                    128)                                                              
                                                                                                      
     conv2d_36 (Conv2D)             (None, None, None,   114688      ['activation_35[0][0]']          
                                    128)                                                              
                                                                                                      
     batch_normalization_31 (BatchN  (None, None, None,   384        ['conv2d_31[0][0]']              
     ormalization)                  128)                                                              
                                                                                                      
     batch_normalization_36 (BatchN  (None, None, None,   384        ['conv2d_36[0][0]']              
     ormalization)                  128)                                                              
                                                                                                      
     activation_31 (Activation)     (None, None, None,   0           ['batch_normalization_31[0][0]'] 
                                    128)                                                              
                                                                                                      
     activation_36 (Activation)     (None, None, None,   0           ['batch_normalization_36[0][0]'] 
                                    128)                                                              
                                                                                                      
     conv2d_32 (Conv2D)             (None, None, None,   114688      ['activation_31[0][0]']          
                                    128)                                                              
                                                                                                      
     conv2d_37 (Conv2D)             (None, None, None,   114688      ['activation_36[0][0]']          
                                    128)                                                              
                                                                                                      
     batch_normalization_32 (BatchN  (None, None, None,   384        ['conv2d_32[0][0]']              
     ormalization)                  128)                                                              
                                                                                                      
     batch_normalization_37 (BatchN  (None, None, None,   384        ['conv2d_37[0][0]']              
     ormalization)                  128)                                                              
                                                                                                      
     activation_32 (Activation)     (None, None, None,   0           ['batch_normalization_32[0][0]'] 
                                    128)                                                              
                                                                                                      
     activation_37 (Activation)     (None, None, None,   0           ['batch_normalization_37[0][0]'] 
                                    128)                                                              
                                                                                                      
     average_pooling2d_3 (AveragePo  (None, None, None,   0          ['mixed3[0][0]']                 
     oling2D)                       768)                                                              
                                                                                                      
     conv2d_30 (Conv2D)             (None, None, None,   147456      ['mixed3[0][0]']                 
                                    192)                                                              
                                                                                                      
     conv2d_33 (Conv2D)             (None, None, None,   172032      ['activation_32[0][0]']          
                                    192)                                                              
                                                                                                      
     conv2d_38 (Conv2D)             (None, None, None,   172032      ['activation_37[0][0]']          
                                    192)                                                              
                                                                                                      
     conv2d_39 (Conv2D)             (None, None, None,   147456      ['average_pooling2d_3[0][0]']    
                                    192)                                                              
                                                                                                      
     batch_normalization_30 (BatchN  (None, None, None,   576        ['conv2d_30[0][0]']              
     ormalization)                  192)                                                              
                                                                                                      
     batch_normalization_33 (BatchN  (None, None, None,   576        ['conv2d_33[0][0]']              
     ormalization)                  192)                                                              
                                                                                                      
     batch_normalization_38 (BatchN  (None, None, None,   576        ['conv2d_38[0][0]']              
     ormalization)                  192)                                                              
                                                                                                      
     batch_normalization_39 (BatchN  (None, None, None,   576        ['conv2d_39[0][0]']              
     ormalization)                  192)                                                              
                                                                                                      
     activation_30 (Activation)     (None, None, None,   0           ['batch_normalization_30[0][0]'] 
                                    192)                                                              
                                                                                                      
     activation_33 (Activation)     (None, None, None,   0           ['batch_normalization_33[0][0]'] 
                                    192)                                                              
                                                                                                      
     activation_38 (Activation)     (None, None, None,   0           ['batch_normalization_38[0][0]'] 
                                    192)                                                              
                                                                                                      
     activation_39 (Activation)     (None, None, None,   0           ['batch_normalization_39[0][0]'] 
                                    192)                                                              
                                                                                                      
     mixed4 (Concatenate)           (None, None, None,   0           ['activation_30[0][0]',          
                                    768)                              'activation_33[0][0]',          
                                                                      'activation_38[0][0]',          
                                                                      'activation_39[0][0]']          
                                                                                                      
     conv2d_44 (Conv2D)             (None, None, None,   122880      ['mixed4[0][0]']                 
                                    160)                                                              
                                                                                                      
     batch_normalization_44 (BatchN  (None, None, None,   480        ['conv2d_44[0][0]']              
     ormalization)                  160)                                                              
                                                                                                      
     activation_44 (Activation)     (None, None, None,   0           ['batch_normalization_44[0][0]'] 
                                    160)                                                              
                                                                                                      
     conv2d_45 (Conv2D)             (None, None, None,   179200      ['activation_44[0][0]']          
                                    160)                                                              
                                                                                                      
     batch_normalization_45 (BatchN  (None, None, None,   480        ['conv2d_45[0][0]']              
     ormalization)                  160)                                                              
                                                                                                      
     activation_45 (Activation)     (None, None, None,   0           ['batch_normalization_45[0][0]'] 
                                    160)                                                              
                                                                                                      
     conv2d_41 (Conv2D)             (None, None, None,   122880      ['mixed4[0][0]']                 
                                    160)                                                              
                                                                                                      
     conv2d_46 (Conv2D)             (None, None, None,   179200      ['activation_45[0][0]']          
                                    160)                                                              
                                                                                                      
     batch_normalization_41 (BatchN  (None, None, None,   480        ['conv2d_41[0][0]']              
     ormalization)                  160)                                                              
                                                                                                      
     batch_normalization_46 (BatchN  (None, None, None,   480        ['conv2d_46[0][0]']              
     ormalization)                  160)                                                              
                                                                                                      
     activation_41 (Activation)     (None, None, None,   0           ['batch_normalization_41[0][0]'] 
                                    160)                                                              
                                                                                                      
     activation_46 (Activation)     (None, None, None,   0           ['batch_normalization_46[0][0]'] 
                                    160)                                                              
                                                                                                      
     conv2d_42 (Conv2D)             (None, None, None,   179200      ['activation_41[0][0]']          
                                    160)                                                              
                                                                                                      
     conv2d_47 (Conv2D)             (None, None, None,   179200      ['activation_46[0][0]']          
                                    160)                                                              
                                                                                                      
     batch_normalization_42 (BatchN  (None, None, None,   480        ['conv2d_42[0][0]']              
     ormalization)                  160)                                                              
                                                                                                      
     batch_normalization_47 (BatchN  (None, None, None,   480        ['conv2d_47[0][0]']              
     ormalization)                  160)                                                              
                                                                                                      
     activation_42 (Activation)     (None, None, None,   0           ['batch_normalization_42[0][0]'] 
                                    160)                                                              
                                                                                                      
     activation_47 (Activation)     (None, None, None,   0           ['batch_normalization_47[0][0]'] 
                                    160)                                                              
                                                                                                      
     average_pooling2d_4 (AveragePo  (None, None, None,   0          ['mixed4[0][0]']                 
     oling2D)                       768)                                                              
                                                                                                      
     conv2d_40 (Conv2D)             (None, None, None,   147456      ['mixed4[0][0]']                 
                                    192)                                                              
                                                                                                      
     conv2d_43 (Conv2D)             (None, None, None,   215040      ['activation_42[0][0]']          
                                    192)                                                              
                                                                                                      
     conv2d_48 (Conv2D)             (None, None, None,   215040      ['activation_47[0][0]']          
                                    192)                                                              
                                                                                                      
     conv2d_49 (Conv2D)             (None, None, None,   147456      ['average_pooling2d_4[0][0]']    
                                    192)                                                              
                                                                                                      
     batch_normalization_40 (BatchN  (None, None, None,   576        ['conv2d_40[0][0]']              
     ormalization)                  192)                                                              
                                                                                                      
     batch_normalization_43 (BatchN  (None, None, None,   576        ['conv2d_43[0][0]']              
     ormalization)                  192)                                                              
                                                                                                      
     batch_normalization_48 (BatchN  (None, None, None,   576        ['conv2d_48[0][0]']              
     ormalization)                  192)                                                              
                                                                                                      
     batch_normalization_49 (BatchN  (None, None, None,   576        ['conv2d_49[0][0]']              
     ormalization)                  192)                                                              
                                                                                                      
     activation_40 (Activation)     (None, None, None,   0           ['batch_normalization_40[0][0]'] 
                                    192)                                                              
                                                                                                      
     activation_43 (Activation)     (None, None, None,   0           ['batch_normalization_43[0][0]'] 
                                    192)                                                              
                                                                                                      
     activation_48 (Activation)     (None, None, None,   0           ['batch_normalization_48[0][0]'] 
                                    192)                                                              
                                                                                                      
     activation_49 (Activation)     (None, None, None,   0           ['batch_normalization_49[0][0]'] 
                                    192)                                                              
                                                                                                      
     mixed5 (Concatenate)           (None, None, None,   0           ['activation_40[0][0]',          
                                    768)                              'activation_43[0][0]',          
                                                                      'activation_48[0][0]',          
                                                                      'activation_49[0][0]']          
                                                                                                      
     conv2d_54 (Conv2D)             (None, None, None,   122880      ['mixed5[0][0]']                 
                                    160)                                                              
                                                                                                      
     batch_normalization_54 (BatchN  (None, None, None,   480        ['conv2d_54[0][0]']              
     ormalization)                  160)                                                              
                                                                                                      
     activation_54 (Activation)     (None, None, None,   0           ['batch_normalization_54[0][0]'] 
                                    160)                                                              
                                                                                                      
     conv2d_55 (Conv2D)             (None, None, None,   179200      ['activation_54[0][0]']          
                                    160)                                                              
                                                                                                      
     batch_normalization_55 (BatchN  (None, None, None,   480        ['conv2d_55[0][0]']              
     ormalization)                  160)                                                              
                                                                                                      
     activation_55 (Activation)     (None, None, None,   0           ['batch_normalization_55[0][0]'] 
                                    160)                                                              
                                                                                                      
     conv2d_51 (Conv2D)             (None, None, None,   122880      ['mixed5[0][0]']                 
                                    160)                                                              
                                                                                                      
     conv2d_56 (Conv2D)             (None, None, None,   179200      ['activation_55[0][0]']          
                                    160)                                                              
                                                                                                      
     batch_normalization_51 (BatchN  (None, None, None,   480        ['conv2d_51[0][0]']              
     ormalization)                  160)                                                              
                                                                                                      
     batch_normalization_56 (BatchN  (None, None, None,   480        ['conv2d_56[0][0]']              
     ormalization)                  160)                                                              
                                                                                                      
     activation_51 (Activation)     (None, None, None,   0           ['batch_normalization_51[0][0]'] 
                                    160)                                                              
                                                                                                      
     activation_56 (Activation)     (None, None, None,   0           ['batch_normalization_56[0][0]'] 
                                    160)                                                              
                                                                                                      
     conv2d_52 (Conv2D)             (None, None, None,   179200      ['activation_51[0][0]']          
                                    160)                                                              
                                                                                                      
     conv2d_57 (Conv2D)             (None, None, None,   179200      ['activation_56[0][0]']          
                                    160)                                                              
                                                                                                      
     batch_normalization_52 (BatchN  (None, None, None,   480        ['conv2d_52[0][0]']              
     ormalization)                  160)                                                              
                                                                                                      
     batch_normalization_57 (BatchN  (None, None, None,   480        ['conv2d_57[0][0]']              
     ormalization)                  160)                                                              
                                                                                                      
     activation_52 (Activation)     (None, None, None,   0           ['batch_normalization_52[0][0]'] 
                                    160)                                                              
                                                                                                      
     activation_57 (Activation)     (None, None, None,   0           ['batch_normalization_57[0][0]'] 
                                    160)                                                              
                                                                                                      
     average_pooling2d_5 (AveragePo  (None, None, None,   0          ['mixed5[0][0]']                 
     oling2D)                       768)                                                              
                                                                                                      
     conv2d_50 (Conv2D)             (None, None, None,   147456      ['mixed5[0][0]']                 
                                    192)                                                              
                                                                                                      
     conv2d_53 (Conv2D)             (None, None, None,   215040      ['activation_52[0][0]']          
                                    192)                                                              
                                                                                                      
     conv2d_58 (Conv2D)             (None, None, None,   215040      ['activation_57[0][0]']          
                                    192)                                                              
                                                                                                      
     conv2d_59 (Conv2D)             (None, None, None,   147456      ['average_pooling2d_5[0][0]']    
                                    192)                                                              
                                                                                                      
     batch_normalization_50 (BatchN  (None, None, None,   576        ['conv2d_50[0][0]']              
     ormalization)                  192)                                                              
                                                                                                      
     batch_normalization_53 (BatchN  (None, None, None,   576        ['conv2d_53[0][0]']              
     ormalization)                  192)                                                              
                                                                                                      
     batch_normalization_58 (BatchN  (None, None, None,   576        ['conv2d_58[0][0]']              
     ormalization)                  192)                                                              
                                                                                                      
     batch_normalization_59 (BatchN  (None, None, None,   576        ['conv2d_59[0][0]']              
     ormalization)                  192)                                                              
                                                                                                      
     activation_50 (Activation)     (None, None, None,   0           ['batch_normalization_50[0][0]'] 
                                    192)                                                              
                                                                                                      
     activation_53 (Activation)     (None, None, None,   0           ['batch_normalization_53[0][0]'] 
                                    192)                                                              
                                                                                                      
     activation_58 (Activation)     (None, None, None,   0           ['batch_normalization_58[0][0]'] 
                                    192)                                                              
                                                                                                      
     activation_59 (Activation)     (None, None, None,   0           ['batch_normalization_59[0][0]'] 
                                    192)                                                              
                                                                                                      
     mixed6 (Concatenate)           (None, None, None,   0           ['activation_50[0][0]',          
                                    768)                              'activation_53[0][0]',          
                                                                      'activation_58[0][0]',          
                                                                      'activation_59[0][0]']          
                                                                                                      
     conv2d_64 (Conv2D)             (None, None, None,   147456      ['mixed6[0][0]']                 
                                    192)                                                              
                                                                                                      
     batch_normalization_64 (BatchN  (None, None, None,   576        ['conv2d_64[0][0]']              
     ormalization)                  192)                                                              
                                                                                                      
     activation_64 (Activation)     (None, None, None,   0           ['batch_normalization_64[0][0]'] 
                                    192)                                                              
                                                                                                      
     conv2d_65 (Conv2D)             (None, None, None,   258048      ['activation_64[0][0]']          
                                    192)                                                              
                                                                                                      
     batch_normalization_65 (BatchN  (None, None, None,   576        ['conv2d_65[0][0]']              
     ormalization)                  192)                                                              
                                                                                                      
     activation_65 (Activation)     (None, None, None,   0           ['batch_normalization_65[0][0]'] 
                                    192)                                                              
                                                                                                      
     conv2d_61 (Conv2D)             (None, None, None,   147456      ['mixed6[0][0]']                 
                                    192)                                                              
                                                                                                      
     conv2d_66 (Conv2D)             (None, None, None,   258048      ['activation_65[0][0]']          
                                    192)                                                              
                                                                                                      
     batch_normalization_61 (BatchN  (None, None, None,   576        ['conv2d_61[0][0]']              
     ormalization)                  192)                                                              
                                                                                                      
     batch_normalization_66 (BatchN  (None, None, None,   576        ['conv2d_66[0][0]']              
     ormalization)                  192)                                                              
                                                                                                      
     activation_61 (Activation)     (None, None, None,   0           ['batch_normalization_61[0][0]'] 
                                    192)                                                              
                                                                                                      
     activation_66 (Activation)     (None, None, None,   0           ['batch_normalization_66[0][0]'] 
                                    192)                                                              
                                                                                                      
     conv2d_62 (Conv2D)             (None, None, None,   258048      ['activation_61[0][0]']          
                                    192)                                                              
                                                                                                      
     conv2d_67 (Conv2D)             (None, None, None,   258048      ['activation_66[0][0]']          
                                    192)                                                              
                                                                                                      
     batch_normalization_62 (BatchN  (None, None, None,   576        ['conv2d_62[0][0]']              
     ormalization)                  192)                                                              
                                                                                                      
     batch_normalization_67 (BatchN  (None, None, None,   576        ['conv2d_67[0][0]']              
     ormalization)                  192)                                                              
                                                                                                      
     activation_62 (Activation)     (None, None, None,   0           ['batch_normalization_62[0][0]'] 
                                    192)                                                              
                                                                                                      
     activation_67 (Activation)     (None, None, None,   0           ['batch_normalization_67[0][0]'] 
                                    192)                                                              
                                                                                                      
     average_pooling2d_6 (AveragePo  (None, None, None,   0          ['mixed6[0][0]']                 
     oling2D)                       768)                                                              
                                                                                                      
     conv2d_60 (Conv2D)             (None, None, None,   147456      ['mixed6[0][0]']                 
                                    192)                                                              
                                                                                                      
     conv2d_63 (Conv2D)             (None, None, None,   258048      ['activation_62[0][0]']          
                                    192)                                                              
                                                                                                      
     conv2d_68 (Conv2D)             (None, None, None,   258048      ['activation_67[0][0]']          
                                    192)                                                              
                                                                                                      
     conv2d_69 (Conv2D)             (None, None, None,   147456      ['average_pooling2d_6[0][0]']    
                                    192)                                                              
                                                                                                      
     batch_normalization_60 (BatchN  (None, None, None,   576        ['conv2d_60[0][0]']              
     ormalization)                  192)                                                              
                                                                                                      
     batch_normalization_63 (BatchN  (None, None, None,   576        ['conv2d_63[0][0]']              
     ormalization)                  192)                                                              
                                                                                                      
     batch_normalization_68 (BatchN  (None, None, None,   576        ['conv2d_68[0][0]']              
     ormalization)                  192)                                                              
                                                                                                      
     batch_normalization_69 (BatchN  (None, None, None,   576        ['conv2d_69[0][0]']              
     ormalization)                  192)                                                              
                                                                                                      
     activation_60 (Activation)     (None, None, None,   0           ['batch_normalization_60[0][0]'] 
                                    192)                                                              
                                                                                                      
     activation_63 (Activation)     (None, None, None,   0           ['batch_normalization_63[0][0]'] 
                                    192)                                                              
                                                                                                      
     activation_68 (Activation)     (None, None, None,   0           ['batch_normalization_68[0][0]'] 
                                    192)                                                              
                                                                                                      
     activation_69 (Activation)     (None, None, None,   0           ['batch_normalization_69[0][0]'] 
                                    192)                                                              
                                                                                                      
     mixed7 (Concatenate)           (None, None, None,   0           ['activation_60[0][0]',          
                                    768)                              'activation_63[0][0]',          
                                                                      'activation_68[0][0]',          
                                                                      'activation_69[0][0]']          
                                                                                                      
     conv2d_72 (Conv2D)             (None, None, None,   147456      ['mixed7[0][0]']                 
                                    192)                                                              
                                                                                                      
     batch_normalization_72 (BatchN  (None, None, None,   576        ['conv2d_72[0][0]']              
     ormalization)                  192)                                                              
                                                                                                      
     activation_72 (Activation)     (None, None, None,   0           ['batch_normalization_72[0][0]'] 
                                    192)                                                              
                                                                                                      
     conv2d_73 (Conv2D)             (None, None, None,   258048      ['activation_72[0][0]']          
                                    192)                                                              
                                                                                                      
     batch_normalization_73 (BatchN  (None, None, None,   576        ['conv2d_73[0][0]']              
     ormalization)                  192)                                                              
                                                                                                      
     activation_73 (Activation)     (None, None, None,   0           ['batch_normalization_73[0][0]'] 
                                    192)                                                              
                                                                                                      
     conv2d_70 (Conv2D)             (None, None, None,   147456      ['mixed7[0][0]']                 
                                    192)                                                              
                                                                                                      
     conv2d_74 (Conv2D)             (None, None, None,   258048      ['activation_73[0][0]']          
                                    192)                                                              
                                                                                                      
     batch_normalization_70 (BatchN  (None, None, None,   576        ['conv2d_70[0][0]']              
     ormalization)                  192)                                                              
                                                                                                      
     batch_normalization_74 (BatchN  (None, None, None,   576        ['conv2d_74[0][0]']              
     ormalization)                  192)                                                              
                                                                                                      
     activation_70 (Activation)     (None, None, None,   0           ['batch_normalization_70[0][0]'] 
                                    192)                                                              
                                                                                                      
     activation_74 (Activation)     (None, None, None,   0           ['batch_normalization_74[0][0]'] 
                                    192)                                                              
                                                                                                      
     conv2d_71 (Conv2D)             (None, None, None,   552960      ['activation_70[0][0]']          
                                    320)                                                              
                                                                                                      
     conv2d_75 (Conv2D)             (None, None, None,   331776      ['activation_74[0][0]']          
                                    192)                                                              
                                                                                                      
     batch_normalization_71 (BatchN  (None, None, None,   960        ['conv2d_71[0][0]']              
     ormalization)                  320)                                                              
                                                                                                      
     batch_normalization_75 (BatchN  (None, None, None,   576        ['conv2d_75[0][0]']              
     ormalization)                  192)                                                              
                                                                                                      
     activation_71 (Activation)     (None, None, None,   0           ['batch_normalization_71[0][0]'] 
                                    320)                                                              
                                                                                                      
     activation_75 (Activation)     (None, None, None,   0           ['batch_normalization_75[0][0]'] 
                                    192)                                                              
                                                                                                      
     max_pooling2d_3 (MaxPooling2D)  (None, None, None,   0          ['mixed7[0][0]']                 
                                    768)                                                              
                                                                                                      
     mixed8 (Concatenate)           (None, None, None,   0           ['activation_71[0][0]',          
                                    1280)                             'activation_75[0][0]',          
                                                                      'max_pooling2d_3[0][0]']        
                                                                                                      
     conv2d_80 (Conv2D)             (None, None, None,   573440      ['mixed8[0][0]']                 
                                    448)                                                              
                                                                                                      
     batch_normalization_80 (BatchN  (None, None, None,   1344       ['conv2d_80[0][0]']              
     ormalization)                  448)                                                              
                                                                                                      
     activation_80 (Activation)     (None, None, None,   0           ['batch_normalization_80[0][0]'] 
                                    448)                                                              
                                                                                                      
     conv2d_77 (Conv2D)             (None, None, None,   491520      ['mixed8[0][0]']                 
                                    384)                                                              
                                                                                                      
     conv2d_81 (Conv2D)             (None, None, None,   1548288     ['activation_80[0][0]']          
                                    384)                                                              
                                                                                                      
     batch_normalization_77 (BatchN  (None, None, None,   1152       ['conv2d_77[0][0]']              
     ormalization)                  384)                                                              
                                                                                                      
     batch_normalization_81 (BatchN  (None, None, None,   1152       ['conv2d_81[0][0]']              
     ormalization)                  384)                                                              
                                                                                                      
     activation_77 (Activation)     (None, None, None,   0           ['batch_normalization_77[0][0]'] 
                                    384)                                                              
                                                                                                      
     activation_81 (Activation)     (None, None, None,   0           ['batch_normalization_81[0][0]'] 
                                    384)                                                              
                                                                                                      
     conv2d_78 (Conv2D)             (None, None, None,   442368      ['activation_77[0][0]']          
                                    384)                                                              
                                                                                                      
     conv2d_79 (Conv2D)             (None, None, None,   442368      ['activation_77[0][0]']          
                                    384)                                                              
                                                                                                      
     conv2d_82 (Conv2D)             (None, None, None,   442368      ['activation_81[0][0]']          
                                    384)                                                              
                                                                                                      
     conv2d_83 (Conv2D)             (None, None, None,   442368      ['activation_81[0][0]']          
                                    384)                                                              
                                                                                                      
     average_pooling2d_7 (AveragePo  (None, None, None,   0          ['mixed8[0][0]']                 
     oling2D)                       1280)                                                             
                                                                                                      
     conv2d_76 (Conv2D)             (None, None, None,   409600      ['mixed8[0][0]']                 
                                    320)                                                              
                                                                                                      
     batch_normalization_78 (BatchN  (None, None, None,   1152       ['conv2d_78[0][0]']              
     ormalization)                  384)                                                              
                                                                                                      
     batch_normalization_79 (BatchN  (None, None, None,   1152       ['conv2d_79[0][0]']              
     ormalization)                  384)                                                              
                                                                                                      
     batch_normalization_82 (BatchN  (None, None, None,   1152       ['conv2d_82[0][0]']              
     ormalization)                  384)                                                              
                                                                                                      
     batch_normalization_83 (BatchN  (None, None, None,   1152       ['conv2d_83[0][0]']              
     ormalization)                  384)                                                              
                                                                                                      
     conv2d_84 (Conv2D)             (None, None, None,   245760      ['average_pooling2d_7[0][0]']    
                                    192)                                                              
                                                                                                      
     batch_normalization_76 (BatchN  (None, None, None,   960        ['conv2d_76[0][0]']              
     ormalization)                  320)                                                              
                                                                                                      
     activation_78 (Activation)     (None, None, None,   0           ['batch_normalization_78[0][0]'] 
                                    384)                                                              
                                                                                                      
     activation_79 (Activation)     (None, None, None,   0           ['batch_normalization_79[0][0]'] 
                                    384)                                                              
                                                                                                      
     activation_82 (Activation)     (None, None, None,   0           ['batch_normalization_82[0][0]'] 
                                    384)                                                              
                                                                                                      
     activation_83 (Activation)     (None, None, None,   0           ['batch_normalization_83[0][0]'] 
                                    384)                                                              
                                                                                                      
     batch_normalization_84 (BatchN  (None, None, None,   576        ['conv2d_84[0][0]']              
     ormalization)                  192)                                                              
                                                                                                      
     activation_76 (Activation)     (None, None, None,   0           ['batch_normalization_76[0][0]'] 
                                    320)                                                              
                                                                                                      
     mixed9_0 (Concatenate)         (None, None, None,   0           ['activation_78[0][0]',          
                                    768)                              'activation_79[0][0]']          
                                                                                                      
     concatenate (Concatenate)      (None, None, None,   0           ['activation_82[0][0]',          
                                    768)                              'activation_83[0][0]']          
                                                                                                      
     activation_84 (Activation)     (None, None, None,   0           ['batch_normalization_84[0][0]'] 
                                    192)                                                              
                                                                                                      
     mixed9 (Concatenate)           (None, None, None,   0           ['activation_76[0][0]',          
                                    2048)                             'mixed9_0[0][0]',               
                                                                      'concatenate[0][0]',            
                                                                      'activation_84[0][0]']          
                                                                                                      
     conv2d_89 (Conv2D)             (None, None, None,   917504      ['mixed9[0][0]']                 
                                    448)                                                              
                                                                                                      
     batch_normalization_89 (BatchN  (None, None, None,   1344       ['conv2d_89[0][0]']              
     ormalization)                  448)                                                              
                                                                                                      
     activation_89 (Activation)     (None, None, None,   0           ['batch_normalization_89[0][0]'] 
                                    448)                                                              
                                                                                                      
     conv2d_86 (Conv2D)             (None, None, None,   786432      ['mixed9[0][0]']                 
                                    384)                                                              
                                                                                                      
     conv2d_90 (Conv2D)             (None, None, None,   1548288     ['activation_89[0][0]']          
                                    384)                                                              
                                                                                                      
     batch_normalization_86 (BatchN  (None, None, None,   1152       ['conv2d_86[0][0]']              
     ormalization)                  384)                                                              
                                                                                                      
     batch_normalization_90 (BatchN  (None, None, None,   1152       ['conv2d_90[0][0]']              
     ormalization)                  384)                                                              
                                                                                                      
     activation_86 (Activation)     (None, None, None,   0           ['batch_normalization_86[0][0]'] 
                                    384)                                                              
                                                                                                      
     activation_90 (Activation)     (None, None, None,   0           ['batch_normalization_90[0][0]'] 
                                    384)                                                              
                                                                                                      
     conv2d_87 (Conv2D)             (None, None, None,   442368      ['activation_86[0][0]']          
                                    384)                                                              
                                                                                                      
     conv2d_88 (Conv2D)             (None, None, None,   442368      ['activation_86[0][0]']          
                                    384)                                                              
                                                                                                      
     conv2d_91 (Conv2D)             (None, None, None,   442368      ['activation_90[0][0]']          
                                    384)                                                              
                                                                                                      
     conv2d_92 (Conv2D)             (None, None, None,   442368      ['activation_90[0][0]']          
                                    384)                                                              
                                                                                                      
     average_pooling2d_8 (AveragePo  (None, None, None,   0          ['mixed9[0][0]']                 
     oling2D)                       2048)                                                             
                                                                                                      
     conv2d_85 (Conv2D)             (None, None, None,   655360      ['mixed9[0][0]']                 
                                    320)                                                              
                                                                                                      
     batch_normalization_87 (BatchN  (None, None, None,   1152       ['conv2d_87[0][0]']              
     ormalization)                  384)                                                              
                                                                                                      
     batch_normalization_88 (BatchN  (None, None, None,   1152       ['conv2d_88[0][0]']              
     ormalization)                  384)                                                              
                                                                                                      
     batch_normalization_91 (BatchN  (None, None, None,   1152       ['conv2d_91[0][0]']              
     ormalization)                  384)                                                              
                                                                                                      
     batch_normalization_92 (BatchN  (None, None, None,   1152       ['conv2d_92[0][0]']              
     ormalization)                  384)                                                              
                                                                                                      
     conv2d_93 (Conv2D)             (None, None, None,   393216      ['average_pooling2d_8[0][0]']    
                                    192)                                                              
                                                                                                      
     batch_normalization_85 (BatchN  (None, None, None,   960        ['conv2d_85[0][0]']              
     ormalization)                  320)                                                              
                                                                                                      
     activation_87 (Activation)     (None, None, None,   0           ['batch_normalization_87[0][0]'] 
                                    384)                                                              
                                                                                                      
     activation_88 (Activation)     (None, None, None,   0           ['batch_normalization_88[0][0]'] 
                                    384)                                                              
                                                                                                      
     activation_91 (Activation)     (None, None, None,   0           ['batch_normalization_91[0][0]'] 
                                    384)                                                              
                                                                                                      
     activation_92 (Activation)     (None, None, None,   0           ['batch_normalization_92[0][0]'] 
                                    384)                                                              
                                                                                                      
     batch_normalization_93 (BatchN  (None, None, None,   576        ['conv2d_93[0][0]']              
     ormalization)                  192)                                                              
                                                                                                      
     activation_85 (Activation)     (None, None, None,   0           ['batch_normalization_85[0][0]'] 
                                    320)                                                              
                                                                                                      
     mixed9_1 (Concatenate)         (None, None, None,   0           ['activation_87[0][0]',          
                                    768)                              'activation_88[0][0]']          
                                                                                                      
     concatenate_1 (Concatenate)    (None, None, None,   0           ['activation_91[0][0]',          
                                    768)                              'activation_92[0][0]']          
                                                                                                      
     activation_93 (Activation)     (None, None, None,   0           ['batch_normalization_93[0][0]'] 
                                    192)                                                              
                                                                                                      
     mixed10 (Concatenate)          (None, None, None,   0           ['activation_85[0][0]',          
                                    2048)                             'mixed9_1[0][0]',               
                                                                      'concatenate_1[0][0]',          
                                                                      'activation_93[0][0]']          
                                                                                                      
    ==================================================================================================
    Total params: 21,802,784
    Trainable params: 21,768,352
    Non-trainable params: 34,432
    __________________________________________________________________________________________________


## 层与贡献


```python
layer_contributions= {
    'mixed2': 0.2,
    'mixed3': 3.,
    'mixed4': 2.,
    'mixed5': 1.5,
}
```

## 损失


```python
# 字典：keys层名values层实例
layer_dict = dict([(layer.name, layer) for layer in model.layers])
# 标量，装层的贡献
loss = K.variable(0.)
# 返回keys有贡献的层名
for layer_name in layer_contributions:
    # 对应层贡献系数
    coeff = layer_contributions[layer_name]
    # 各层的激活
    activation = layer_dict[layer_name].output
    
    # l2范数添加到损失
    scaling = K.prod(K.cast(K.shape(activation), 'float32'))
    loss = loss + coeff * K.sum(K.square(activation[:, 2: -2, 2: -2, :])) / scaling
```

## 梯度上升


```python
# 保存生成的图像
dream = model.input
# 计算损失相对于梦境图像的梯度
grads = K.gradients(loss, dream)[0]
# 梯度标准化
grads /= K.maximum(K.mean(K.abs(grads)), 1e-7)
# 该函数获取输出图像的损失与梯度
outputs = [loss, grads]
fetch_loss_and_grads = K.function([dream], outputs)
```


```python
# 分装输出图像的损失与梯度
def eval_loss_and_grads(x):
    outs = fetch_loss_and_grads(x)
    loss_value = outs[0]
    grad_values = outs[1]
    return loss_value, grad_values
# 利用梯度值进行iterations次梯度上升
def gradient_ascent(x, iterations, step, max_loss=None):
    for i in range(iterations):
        loss_value, grad_values = eval_loss_and_grads(x)
        if max_loss is not None and loss_value > max_loss:
            break
        print('...Loss value at', i, ':', loss_value)
        x = x + step * grad_values
    return x
```

## 辅助函数


```python
import scipy
import imageio
from keras.preprocessing import image
def resize_img(img, size):
    """
    ???在干嘛???
    """
    img = np.copy(img)
    factors = (1,
              float(size[0]) / img.shape[1],
              float(size[1]) / img.shape[2],
              1)
    return scipy.ndimage.zoom(img, factors, order=1)
def save_img(img, fname):
    pil_img = deprocess_image(np.copy(img))
#     scipy.misc.imsave(fname, pil_img)
    imageio.imwrite(fname, pil_img)
def preprocess_image(image_path):
    img = image.load_img(image_path)
    img = image.img_to_array(img)
    img = np.expand_dims(img, axis=0)
    img = inception_v3.preprocess_input(img)
    return img
def deprocess_image(x):
    if K.image_data_format() == 'channels_first':
        x = x.reshape((3, x.shape[2], x.shape[3]))
        x = x.transpose((1,2,0))
    else:
        x = x.reshape((x.shape[1], x.shape[2], 3))
    x /= 2
    x += 0.5
    x *= 255.
    x = np.clip(x, 0, 255).astype('uint8')
    return x
```


```python
# 为了对resize_img函数理解
# 原图更改图片大小，并增加批量维度
img2 = preprocess_image(base_image_path)
print(img2.shape)
img3 = np.copy(img2)
print(successive_shapes[:2])
factors = (1,
          float(successive_shapes[0][0]) / img3.shape[1],
          float(successive_shapes[0][1]) / img3.shape[2],
          1)
a = scipy.ndimage.zoom(img3, factors, order=1)
print(a)
print(a.shape)
```

    (1, 1304, 1965, 3)
    [(665, 1002), (931, 1403)]
    [[[[-0.49019605 -0.52156866 -0.5921569 ]
       [-0.47510526 -0.5064779  -0.5770661 ]
       [-0.46726212 -0.49863467 -0.569223  ]
       ...
       [ 0.0196079  -0.05882353 -0.25490195]
       [ 0.01176476 -0.06666666 -0.26274508]
       [ 0.01176476 -0.06666666 -0.26274508]]
    
      [[-0.4748051  -0.50617766 -0.5767659 ]
       [-0.46725968 -0.49863222 -0.56922054]
       [-0.4739143  -0.5052869  -0.5758751 ]
       ...
       [ 0.01087398 -0.07510528 -0.2485402 ]
       [-0.02018091 -0.10616011 -0.27959502]
       [-0.03470352 -0.12068272 -0.29411763]]
    
      [[-0.4588235  -0.49019605 -0.56078434]
       [-0.46639132 -0.49776387 -0.56835216]
       [-0.4739143  -0.5052869  -0.5758751 ]
       ...
       [ 0.03469381 -0.05158076 -0.2096247 ]
       [-0.00422419 -0.0904987  -0.24854264]
       [-0.02686038 -0.11313488 -0.2711788 ]]
    
      ...
    
      [[-0.84313726 -0.84313726 -0.78039217]
       [-0.8277487  -0.8277487  -0.7650036 ]
       [-0.8123602  -0.8123602  -0.74961513]
       ...
       [-0.7641104  -0.8346986  -0.8268555 ]
       [-0.74087876 -0.811467   -0.80362386]
       [-0.73333335 -0.8039216  -0.79607844]]
    
      [[-0.8512757  -0.8512757  -0.7885306 ]
       [-0.8358872  -0.8358872  -0.7731421 ]
       [-0.82049865 -0.82049865 -0.75775355]
       ...
       [-0.7565675  -0.8271557  -0.8193126 ]
       [-0.7493149  -0.81990314 -0.81206   ]
       [-0.7493149  -0.81990314 -0.81206   ]]
    
      [[-0.8666667  -0.8666667  -0.8039216 ]
       [-0.8512781  -0.8512781  -0.78853303]
       [-0.83588964 -0.83588964 -0.77314454]
       ...
       [-0.741772   -0.8123602  -0.8045171 ]
       [-0.7571605  -0.8277487  -0.8199056 ]
       [-0.7647059  -0.8352941  -0.827451  ]]]]
    (1, 665, 1002, 3)


## 梯度上升


```python
# 步长
step = 0.01
# 八度的个数
num_octave = 3
# 八度放大比例
octave_scale = 1.4
# 梯度上升次数
iterations = 20
# 损失增到10就停，避免丑
max_loss = 10.
# 原图路径
base_image_path = '/Users/zhangdi/Desktop/deeplearning/downloads/IMG_95722.jpg'
# 格式转换成模型需要的输入张量
img = preprocess_image(base_image_path)
# 扔掉批量与通道维度，单纯高宽
original_shape = img.shape[1:3]
# 装不同的八度尺寸
successive_shapes = [original_shape]
# 对前两个八度梯度上升
for i in range(1, num_octave):
    # 原图是1304、1965，第一八度/1.96，第二八度/1.4，第三八度原图
    shape = tuple([int(dim / (octave_scale ** i)) for dim in original_shape])
    # 保存前两个八度梯度上升时该有的图片高宽
    successive_shapes.append(shape)
# 倒转使第一八度/1.96，第二八度/1.4，第三八度原图
successive_shapes = successive_shapes[::-1]
# 原先的图片张量
original_img = np.copy(img)
# 原图(1304, 1965)改成(1, 665, 1002, 3)
shrunck_original_img = resize_img(img, successive_shapes[0])
# 对不同八度的图片尺寸
for shape in successive_shapes:
    print('Processing image shape', shape)
    # 原图(1304, 1965)改成(1, 665, 1002, 3)
    img = resize_img(img, shape)
    # 对图像20次0.01梯度上升，直到损失到10
    img = gradient_ascent(img,
                         iterations=iterations,
                         step=step,
                         max_loss=max_loss)
    # 放大最收缩的图。(1, 665, 1002, 3)改成(1, 665, 1002, 3)、(1, 931, 1403, 3)、(1, 1304, 1965, 3)
    upscaled_shrunk_original_img = resize_img(shrunck_original_img, shape)
    # (1, 1304, 1965, 3)改成各
    same_size_original = resize_img(original_img, shape)
    # 放大会变模糊，失去细节。由小减大图即细节
    lost_detail = same_size_original - upscaled_shrunk_original_img
    
    img += lost_detail
    # 更新已收缩原图
    shrunck_original_img = resize_img(original_img, shape)
    save_img(img, fname='dream_at_scale_' + str(shape) + '.png')    # 图名
save_img(img, fname='final_dream.png')
```

    Processing image shape (665, 1002)
    ...Loss value at 0 : 2.5180333
    ...Loss value at 1 : 3.0310378
    ...Loss value at 2 : 3.7944899
    ...Loss value at 3 : 4.5473413
    ...Loss value at 4 : 5.295175
    ...Loss value at 5 : 6.0131683
    ...Loss value at 6 : 6.731263
    ...Loss value at 7 : 7.41757
    ...Loss value at 8 : 8.085599
    ...Loss value at 9 : 8.734765
    ...Loss value at 10 : 9.37153
    ...Loss value at 11 : 9.988023
    Processing image shape (931, 1403)
    ...Loss value at 0 : 3.6039712
    ...Loss value at 1 : 4.9656496
    ...Loss value at 2 : 6.0638814
    ...Loss value at 3 : 7.011126
    ...Loss value at 4 : 7.902362
    ...Loss value at 5 : 8.739111
    ...Loss value at 6 : 9.526682
    Processing image shape (1304, 1965)
    ...Loss value at 0 : 3.582926
    ...Loss value at 1 : 4.864186
    ...Loss value at 2 : 5.9363046
    ...Loss value at 3 : 6.9048533
    ...Loss value at 4 : 7.828673
    ...Loss value at 5 : 8.700015
    ...Loss value at 6 : 9.517556


# VGG19神经风格迁移

## 初始变量


```python
from keras.preprocessing.image import load_img, img_to_array
# 内容图路径、风格图路径、原图高宽、最好同比例400
target_image_path = '/Users/zhangdi/Desktop/deeplearning/downloads/IMG_1488.JPG'
style_reference_image_path = '/Users/zhangdi/Desktop/deeplearning/downloads/WechatIMG377.png'
width, height = load_img(target_image_path).size
img_height = 400
img_width = int(width * img_height / height)
```

## 辅助函数


```python
from keras.applications import vgg19
def preprocess_image(image_path):
    img = load_img(image_path, target_size=(img_height, img_width))
    img = img_to_array(img)
    img = np.expand_dims(img, axis=0)
    # 像素减去平均值
    img = vgg19.preprocess_input(img)
    return img
def deprocess_image(x):
    # 逆操作，加回平均值
    x[:, :, 0] += 103.939
    x[:, :, 1] += 116.779
    # BGR转回RGB
    x = x[:, :, ::-1]
    x = np.clip(x, 0, 255).astype('uint8')
    return x
```


```python
from keras import backend as K
import tensorflow as tf
tf.compat.v1.disable_eager_execution()
```

## 加载模型与权重并应用于图片


```python
target_image = K.constant(preprocess_image(target_image_path))
style_reference_image = K.constant(preprocess_image(style_reference_image_path))
combination_image = K.placeholder((1, img_height, img_width, 3))
# 按照第一维结合。图像通道分别为内容、风格、合成图特征
input_tensor = K.concatenate([target_image,
                             style_reference_image,
                             combination_image], axis=0)
model = vgg19.VGG19(input_tensor=input_tensor,
                   weights='imagenet',
                   include_top=False)
print('Model loaded.')
```

    Downloading data from https://storage.googleapis.com/tensorflow/keras-applications/vgg19/vgg19_weights_tf_dim_ordering_tf_kernels_notop.h5
    80142336/80134624 [==============================] - 84s 1us/step
    80150528/80134624 [==============================] - 84s 1us/step
    Model loaded.


    2022-06-08 19:55:19.213332: W tensorflow/core/platform/profile_utils/cpu_utils.cc:128] Failed to get CPU frequency: 0 Hz


## 定义三个损失函数，格拉姆矩阵


```python
# 内容损失为距离的平方(保存顶层全局、抽象信息)
def content_loss(base, combination):
    return K.sum(K.square(combination - base))
# 特征之间的相互关系，即纹理，也即风格
def gram_matrix(x):
    features = K.batch_flatten(K.permute_dimensions(x, (2, 0, 1)))
    gram = K.dot(features, K.transpose(features))
    return gram
# 风格图的纹理与合成图的纹理，在干嘛？
def style_loss(style, combination):
    S = gram_matrix(style)
    C = gram_matrix(combination)
    channels = 3
    size = img_height * img_width
    return K.sum(K.square(S - C)) / (4. * (channels ** 2) * (size ** 2))
# 总变差损失，正则化损失吗避免结果过度像素化
def total_variation_loss(x):
    a = K.square(
        x[:, :img_height - 1, :img_width - 1, :] - x[:, 1:, :img_width - 1, :])
    b = K.square(
        x[:, :img_height - 1, :img_width - 1, :] - x[:, :img_height - 1, 1:, :])
    return K.sum(K.pow(a + b, 1.25))
```

## 加权后的最终损失


```python
# 所有层名输出与内容、风格损失层
outputs_dict = dict([(layer.name, layer.output) for layer in model.layers])
content_layer = 'block5_conv2'
style_layers = ['block1_conv1',
               'block2_conv1',
               'block3_conv1',
               'block4_conv1',
               'block5_conv1']
# 各损失的加权权重
total_variation_weight = 1e-4
style_weight = 1.
content_weight = 0.025

loss = K.variable(0.)
# 内容层的输出特征图。第一像素通道为内容图特征？第三像素通道为合成图？？
layer_features = outputs_dict[content_layer]
target_image_features = layer_features[0, :, :, :]
combination_features = layer_features[2, :, :, :]
# 加权后的内容损失
loss = loss + content_weight * content_loss(target_image_features, combination_features)
for layer_name in style_layers:
    layer_features = outputs_dict[layer_name]
    # 第二像素通道为风格图特征？？？
    style_reference_features = layer_features[1, :, :, :]
    combination_features = layer_features[2, :, :, :]
    s1 = style_loss(style_reference_features, combination_features)
    # 对风格损失加权，权重要按层数平均化
    loss = loss + (style_weight / len(style_layers)) * s1
# 最后添加总变差损失
loss = loss + total_variation_weight * total_variation_loss(combination_image)
```


```python
model.summary()
```

    Model: "vgg19"
    _________________________________________________________________
     Layer (type)                Output Shape              Param #   
    =================================================================
     input_1 (InputLayer)        [(3, 400, 400, 3)]        0         
                                                                     
     block1_conv1 (Conv2D)       (3, 400, 400, 64)         1792      
                                                                     
     block1_conv2 (Conv2D)       (3, 400, 400, 64)         36928     
                                                                     
     block1_pool (MaxPooling2D)  (3, 200, 200, 64)         0         
                                                                     
     block2_conv1 (Conv2D)       (3, 200, 200, 128)        73856     
                                                                     
     block2_conv2 (Conv2D)       (3, 200, 200, 128)        147584    
                                                                     
     block2_pool (MaxPooling2D)  (3, 100, 100, 128)        0         
                                                                     
     block3_conv1 (Conv2D)       (3, 100, 100, 256)        295168    
                                                                     
     block3_conv2 (Conv2D)       (3, 100, 100, 256)        590080    
                                                                     
     block3_conv3 (Conv2D)       (3, 100, 100, 256)        590080    
                                                                     
     block3_conv4 (Conv2D)       (3, 100, 100, 256)        590080    
                                                                     
     block3_pool (MaxPooling2D)  (3, 50, 50, 256)          0         
                                                                     
     block4_conv1 (Conv2D)       (3, 50, 50, 512)          1180160   
                                                                     
     block4_conv2 (Conv2D)       (3, 50, 50, 512)          2359808   
                                                                     
     block4_conv3 (Conv2D)       (3, 50, 50, 512)          2359808   
                                                                     
     block4_conv4 (Conv2D)       (3, 50, 50, 512)          2359808   
                                                                     
     block4_pool (MaxPooling2D)  (3, 25, 25, 512)          0         
                                                                     
     block5_conv1 (Conv2D)       (3, 25, 25, 512)          2359808   
                                                                     
     block5_conv2 (Conv2D)       (3, 25, 25, 512)          2359808   
                                                                     
     block5_conv3 (Conv2D)       (3, 25, 25, 512)          2359808   
                                                                     
     block5_conv4 (Conv2D)       (3, 25, 25, 512)          2359808   
                                                                     
     block5_pool (MaxPooling2D)  (3, 12, 12, 512)          0         
                                                                     
    =================================================================
    Total params: 20,024,384
    Trainable params: 20,024,384
    Non-trainable params: 0
    _________________________________________________________________


## 梯度下降，同时计算损失与梯度


```python
grads = K.gradients(loss, combination_image)[0]
fetch_loss_and_grads = K.function([combination_image], [loss, grads])
class Evaluator(object):
    def __init__(self):
        self.loss_value = None
        self.grads_values = None
    def loss(self, x):
        assert self.loss_value is None
        x = x.reshape((1, img_height, img_width, 3))
        outs = fetch_loss_and_grads([x])
        loss_value = outs[0]
        grad_values = outs[1].flatten().astype('float64')
        self.loss_value = loss_value
        self.grad_values = grad_values
        return self.loss_value
    def grads(self, x):
        assert self.loss_value is not None
        grad_values = np.copy(self.grad_values)
        self.loss_value = None
        self.grad_values = None
        return grad_values
evaluator = Evaluator()
```


```python
from scipy.optimize import fmin_l_bfgs_b
import imageio
import time

result_prefix = 'my_result'
iterations = 20

x = preprocess_image(target_image_path)
x = x.flatten()
for i in range(iterations):
    print('Start of iteration', i)
    start_time = time.time()
    x, min_val, info = fmin_l_bfgs_b(evaluator.loss,
                                    x,
                                    fprime=evaluator.grads,
                                    maxfun=20)
    print('Current loss value:', min_val)
    img = x.copy().reshape((img_height, img_width, 3))
    img = deprocess_image(img)
    fname = result_prefix + '_at_iteration_%d.png' % i
    imageio.imwrite(fname, img)
    print('Image saved as', fname)
    end_time = time.time()
    print('Iteration %d completed in %ds' % (i, end_time-start_time))
```

    Start of iteration 0
    Current loss value: 768675460.0
    Image saved as my_result_at_iteration_0.png
    Iteration 0 completed in 62s
    Start of iteration 1
    Current loss value: 333521860.0
    Image saved as my_result_at_iteration_1.png
    Iteration 1 completed in 68s
    Start of iteration 2
    Current loss value: 215650900.0
    Image saved as my_result_at_iteration_2.png
    Iteration 2 completed in 70s
    Start of iteration 3
    Current loss value: 175719300.0
    Image saved as my_result_at_iteration_3.png
    Iteration 3 completed in 74s
    Start of iteration 4
    Current loss value: 147850990.0
    Image saved as my_result_at_iteration_4.png
    Iteration 4 completed in 71s
    Start of iteration 5
    Current loss value: 131515280.0
    Image saved as my_result_at_iteration_5.png
    Iteration 5 completed in 73s
    Start of iteration 6
    Current loss value: 120486190.0
    Image saved as my_result_at_iteration_6.png
    Iteration 6 completed in 72s
    Start of iteration 7
    Current loss value: 112448424.0
    Image saved as my_result_at_iteration_7.png
    Iteration 7 completed in 72s
    Start of iteration 8
    Current loss value: 106312320.0
    Image saved as my_result_at_iteration_8.png
    Iteration 8 completed in 72s
    Start of iteration 9
    Current loss value: 100406780.0
    Image saved as my_result_at_iteration_9.png
    Iteration 9 completed in 73s
    Start of iteration 10
    Current loss value: 95526410.0
    Image saved as my_result_at_iteration_10.png
    Iteration 10 completed in 73s
    Start of iteration 11
    Current loss value: 91911650.0
    Image saved as my_result_at_iteration_11.png
    Iteration 11 completed in 73s
    Start of iteration 12
    Current loss value: 88917304.0
    Image saved as my_result_at_iteration_12.png
    Iteration 12 completed in 72s
    Start of iteration 13
    Current loss value: 85029540.0
    Image saved as my_result_at_iteration_13.png
    Iteration 13 completed in 73s
    Start of iteration 14
    Current loss value: 81761870.0
    Image saved as my_result_at_iteration_14.png
    Iteration 14 completed in 73s
    Start of iteration 15
    Current loss value: 79322540.0
    Image saved as my_result_at_iteration_15.png
    Iteration 15 completed in 73s
    Start of iteration 16
    Current loss value: 76925580.0
    Image saved as my_result_at_iteration_16.png
    Iteration 16 completed in 73s
    Start of iteration 17
    Current loss value: 74774740.0
    Image saved as my_result_at_iteration_17.png
    Iteration 17 completed in 73s
    Start of iteration 18
    Current loss value: 72917110.0
    Image saved as my_result_at_iteration_18.png
    Iteration 18 completed in 73s
    Start of iteration 19
    Current loss value: 71159690.0
    Image saved as my_result_at_iteration_19.png
    Iteration 19 completed in 74s


# VAE（variational autoencoder

## 输入编码为均值与方差


```python
import keras
from keras import layers
from keras.models import Model
img_shape = (28, 28, 1)
batch_size= 16
# 潜在空间为2维
latent_dim = 2

input_img = keras.Input(shape=img_shape)
x = layers.Conv2D(32, 3, padding='same', activation='relu', strides=(2, 2))(input_img)
x = layers.Conv2D(64, 3, padding='same', activation='relu', strides=(2, 2))(x)
x = layers.Conv2D(64, 3, padding='same', activation='relu')(x)
x = layers.Conv2D(64, 3, padding='same', activation='relu')(x)
shape_before_flattening = K.int_shape(x)
x = layers.Flatten()(x)
x = layers.Dense(32, activation='relu')(x)

z_mean = layers.Dense(latent_dim)(x)
z_log_var = layers.Dense(latent_dim)(x)
```

## 用epsilon抽取潜在点


```python
def sampling(args):
    z_mean, z_log_var = args
    batch = K.shape(z_mean)[0]
    dim = K.int_shape(z_mean)[1]
    epsilon = K.random_normal(shape=(batch, dim),
                             mean=0., stddev=1.)
    return z_mean + K.exp(0.5 * z_log_var) * epsilon
z = layers.Lambda(sampling)([z_mean, z_log_var])
```

## 潜在点解码为图像


```python
decoder_input = layers.Input(K.int_shape(z)[1:])
x = layers.Dense(np.prod(shape_before_flattening[1:]),
                activation='relu')(decoder_input)
x = layers.Reshape(shape_before_flattening[1:])(x)
x = layers.Conv2DTranspose(32, 3, padding='same', activation='relu', strides=(2, 2))(x)
x = layers.Conv2D(1, 3, padding='same', activation='sigmoid')(x)
decoder = Model(decoder_input, x)
z_decoded = decoder(z)
```

## 定义双重损失


```python
class CustomVariationalLayer(keras.layers.Layer):
    def vae_loss(self, x, z_decoded):
        x = K.flatten(x)
        z_decoded = K.flatten(z_decoded)
        xent_loss = keras.metrics.binary_crossentropy(x, z_decoded)
        kl_loss = -5e-4 * K.mean(
            1 + z_log_var - K.square(z_mean) - K.exp(z_log_var), axis=-1)
        return K.mean(xent_loss + kl_loss[:, None])
    def call(self, inputs):
        x = inputs[0]
        z_decoded = inputs[1]
        loss = self.vae_loss(x, z_decoded)
        self.add_loss(loss, inputs=inputs)
        return x
y = CustomVariationalLayer()([input_img, z_decoded])
```


```python
from keras.datasets import mnist
vae = Model(input_img, y)
vae.compile(optimizer='rmsprop', loss=None)
vae.summary()
```

    WARNING:tensorflow:Output custom_variational_layer_6 missing from loss dictionary. We assume this was done on purpose. The fit and evaluate APIs will not be expecting any data to be passed to custom_variational_layer_6.
    Model: "model_9"
    __________________________________________________________________________________________________
     Layer (type)                   Output Shape         Param #     Connected to                     
    ==================================================================================================
     input_8 (InputLayer)           [(None, 28, 28, 1)]  0           []                               
                                                                                                      
     conv2d_12 (Conv2D)             (None, 14, 14, 32)   320         ['input_8[0][0]']                
                                                                                                      
     conv2d_13 (Conv2D)             (None, 7, 7, 64)     18496       ['conv2d_12[0][0]']              
                                                                                                      
     conv2d_14 (Conv2D)             (None, 7, 7, 64)     36928       ['conv2d_13[0][0]']              
                                                                                                      
     conv2d_15 (Conv2D)             (None, 7, 7, 64)     36928       ['conv2d_14[0][0]']              
                                                                                                      
     flatten_2 (Flatten)            (None, 3136)         0           ['conv2d_15[0][0]']              
                                                                                                      
     dense_9 (Dense)                (None, 32)           100384      ['flatten_2[0][0]']              
                                                                                                      
     dense_10 (Dense)               (None, 2)            66          ['dense_9[0][0]']                
                                                                                                      
     dense_11 (Dense)               (None, 2)            66          ['dense_9[0][0]']                
                                                                                                      
     lambda_4 (Lambda)              (None, 2)            0           ['dense_10[0][0]',               
                                                                      'dense_11[0][0]']               
                                                                                                      
     model_8 (Functional)           (None, 14, 14, 1)    28161       ['lambda_4[0][0]']               
                                                                                                      
     custom_variational_layer_6 (Cu  (None, 28, 28, 1)   0           ['input_8[0][0]',                
     stomVariationalLayer)                                            'model_8[0][0]']                
                                                                                                      
    ==================================================================================================
    Total params: 221,349
    Trainable params: 221,349
    Non-trainable params: 0
    __________________________________________________________________________________________________



```python
(x_train, _), (x_test, y_test) = mnist.load_data()
x_train = x_train.astype('float32') / 255.
x_train = x_train.reshape(x_train.shape + (1,))
x_test = x_test.astype('float32') / 255.
x_test = x_test.reshape(x_test.shape + (1,))

vae.fit(x=x_train, y=None,
       shuffle=True,
       epochs=10,
       batch_size=batch_size,
       validation_data=(x_test, None))
```

    Train on 60000 samples, validate on 10000 samples
    Epoch 1/10



    ---------------------------------------------------------------------------

    InvalidArgumentError                      Traceback (most recent call last)

    Input In [59], in <cell line: 7>()
          4 x_test = x_test.astype('float32') / 255.
          5 x_test = x_test.reshape(x_test.shape + (1,))
    ----> 7 vae.fit(x=x_train, y=None,
          8        shuffle=True,
          9        epochs=10,
         10        batch_size=batch_size,
         11        validation_data=(x_test, None))


    File ~/miniforge3/envs/dl/lib/python3.10/site-packages/keras/engine/training_v1.py:777, in Model.fit(self, x, y, batch_size, epochs, verbose, callbacks, validation_split, validation_data, shuffle, class_weight, sample_weight, initial_epoch, steps_per_epoch, validation_steps, validation_freq, max_queue_size, workers, use_multiprocessing, **kwargs)
        774 self._check_call_args('fit')
        776 func = self._select_training_loop(x)
    --> 777 return func.fit(
        778     self,
        779     x=x,
        780     y=y,
        781     batch_size=batch_size,
        782     epochs=epochs,
        783     verbose=verbose,
        784     callbacks=callbacks,
        785     validation_split=validation_split,
        786     validation_data=validation_data,
        787     shuffle=shuffle,
        788     class_weight=class_weight,
        789     sample_weight=sample_weight,
        790     initial_epoch=initial_epoch,
        791     steps_per_epoch=steps_per_epoch,
        792     validation_steps=validation_steps,
        793     validation_freq=validation_freq,
        794     max_queue_size=max_queue_size,
        795     workers=workers,
        796     use_multiprocessing=use_multiprocessing)


    File ~/miniforge3/envs/dl/lib/python3.10/site-packages/keras/engine/training_arrays_v1.py:641, in ArrayLikeTrainingLoop.fit(self, model, x, y, batch_size, epochs, verbose, callbacks, validation_split, validation_data, shuffle, class_weight, sample_weight, initial_epoch, steps_per_epoch, validation_steps, validation_freq, **kwargs)
        637     raise ValueError('`validation_steps` should not be specified if '
        638                      '`validation_data` is None.')
        639   val_x, val_y, val_sample_weights = None, None, None
    --> 641 return fit_loop(
        642     model,
        643     inputs=x,
        644     targets=y,
        645     sample_weights=sample_weights,
        646     batch_size=batch_size,
        647     epochs=epochs,
        648     verbose=verbose,
        649     callbacks=callbacks,
        650     val_inputs=val_x,
        651     val_targets=val_y,
        652     val_sample_weights=val_sample_weights,
        653     shuffle=shuffle,
        654     initial_epoch=initial_epoch,
        655     steps_per_epoch=steps_per_epoch,
        656     validation_steps=validation_steps,
        657     validation_freq=validation_freq,
        658     steps_name='steps_per_epoch')


    File ~/miniforge3/envs/dl/lib/python3.10/site-packages/keras/engine/training_arrays_v1.py:377, in model_iteration(model, inputs, targets, sample_weights, batch_size, epochs, verbose, callbacks, val_inputs, val_targets, val_sample_weights, shuffle, initial_epoch, steps_per_epoch, validation_steps, validation_freq, mode, validation_in_fit, prepared_feed_values_from_dataset, steps_name, **kwargs)
        374 callbacks._call_batch_hook(mode, 'begin', batch_index, batch_logs)
        376 # Get outputs.
    --> 377 batch_outs = f(ins_batch)
        378 if not isinstance(batch_outs, list):
        379   batch_outs = [batch_outs]


    File ~/miniforge3/envs/dl/lib/python3.10/site-packages/keras/backend.py:4275, in GraphExecutionFunction.__call__(self, inputs)
       4269 if (self._callable_fn is None or feed_arrays != self._feed_arrays or
       4270     symbol_vals != self._symbol_vals or
       4271     feed_symbols != self._feed_symbols or self.fetches != self._fetches or
       4272     session != self._session):
       4273   self._make_callable(feed_arrays, feed_symbols, symbol_vals, session)
    -> 4275 fetched = self._callable_fn(*array_vals,
       4276                             run_metadata=self.run_metadata)
       4277 self._call_fetch_callbacks(fetched[-len(self._fetches):])
       4278 output_structure = tf.nest.pack_sequence_as(
       4279     self._outputs_structure,
       4280     fetched[:len(self.outputs)],
       4281     expand_composites=True)


    File ~/miniforge3/envs/dl/lib/python3.10/site-packages/tensorflow/python/client/session.py:1480, in BaseSession._Callable.__call__(self, *args, **kwargs)
       1478 try:
       1479   run_metadata_ptr = tf_session.TF_NewBuffer() if run_metadata else None
    -> 1480   ret = tf_session.TF_SessionRunCallable(self._session._session,
       1481                                          self._handle, args,
       1482                                          run_metadata_ptr)
       1483   if run_metadata:
       1484     proto_data = tf_session.TF_GetBuffer(run_metadata_ptr)


    InvalidArgumentError: Incompatible shapes: [3136] vs. [12544]
    	 [[{{node custom_variational_layer_6/mul_1}}]]

